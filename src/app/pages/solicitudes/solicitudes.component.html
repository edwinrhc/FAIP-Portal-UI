<!-- Header + Progreso -->
<header class="max-w-3xl mx-auto mt-6 mb-4">
  <div class="flex items-center gap-3">
    <div class="w-10 h-10 rounded bg-blue-900"></div>
    <div>
      <p class="text-sm text-gray-500 leading-tight">Plataforma de Trámites</p>
      <h1 class="text-2xl font-semibold text-gray-900 leading-tight">Registro de Solicitud</h1>
    </div>
  </div>

  <div class="mt-4">
    <div class="flex items-center justify-between text-xs font-medium text-gray-600">
      <span [class.text-blue-700]="currentStep===1">Paso 1: Identificación</span>
      <span [class.text-blue-700]="currentStep===2">Paso 2: Detalle y envío</span>
    </div>
    <div class="mt-2 h-2 rounded-full bg-gray-200 overflow-hidden">
      <div class="h-full bg-blue-600 transition-all" [style.width.%]="stepProgressPct"></div>
    </div>
  </div>

  <p class="mt-2 text-sm text-gray-600">
    Los campos marcados con <span class="text-red-600">*</span> son obligatorios.
  </p>
</header>

<div class="max-w-3xl mx-auto grid lg:grid-cols-3 gap-6 pb-12">
  <!-- Formulario -->
  <form class="lg:col-span-2 space-y-6" [formGroup]="form" (ngSubmit)="onSubmit()" novalidate>

    <!-- PASO 1: Solicitante -->
    <section *ngIf="currentStep === 1" class="bg-white rounded-xl shadow-sm ring-1 ring-gray-200">
      <div class="px-5 py-4 border-b border-gray-200 rounded-t-xl bg-gray-50">
        <h2 class="text-base font-semibold text-gray-900">Datos del solicitante</h2>
        <p class="text-xs text-gray-500 mt-1">Identifique al solicitante y datos de contacto.</p>
      </div>
      <div class="p-5 space-y-4">

        <!-- Tipo de Solicitante -->
        <div>
          <label for="tipoSolicitante" class="block text-sm font-medium text-gray-800">
            Tipo de solicitante <span class="text-red-600">*</span>
          </label>
          <select id="tipoSolicitante" formControlName="tipoSolicitante"
                  class="mt-1 block w-full rounded-lg border-gray-300 focus:border-blue-600 focus:ring-blue-600">
            <option [ngValue]="null" disabled selected>— Seleccione —</option>
            <option value="Persona Natural">Persona Natural</option>
            <option value="JURIDICA">Persona Jurídica</option>
          </select>
          <p class="mt-1 text-xs text-gray-500">Seleccione el tipo de persona que presenta la solicitud.</p>
          <p *ngIf="form.get('tipoSolicitante')?.touched && form.get('tipoSolicitante')?.invalid"
             class="mt-1 text-sm text-red-600">Este campo es obligatorio.</p>
        </div>

        <!-- Persona Natural -->
        <div *ngIf="isPersonaNatural()" class="grid sm:grid-cols-2 gap-4">
          <div>
            <label for="tipoDocumento" class="block text-sm font-medium text-gray-800">
              Tipo de documento <span class="text-red-600">*</span>
            </label>
            <input id="tipoDocumento" formControlName="tipoDocumento" placeholder="DNI"
                   class="mt-1 block w-full rounded-lg border-gray-300 focus:border-blue-600 focus:ring-blue-600"/>
          </div>
          <div>
            <label for="numeroDocumento" class="block text-sm font-medium text-gray-800">
              N° de documento <span class="text-red-600">*</span>
            </label>
            <input id="numeroDocumento" formControlName="numeroDocumento" placeholder="Ej. 12345678"
                   class="mt-1 block w-full rounded-lg border-gray-300 focus:border-blue-600 focus:ring-blue-600"/>
            <p *ngIf="form.get('numeroDocumento')?.touched && form.get('numeroDocumento')?.invalid"
               class="mt-1 text-sm text-red-600">Ingrese un número válido.</p>
          </div>

          <div class="sm:col-span-2">
            <label for="nombres" class="block text-sm font-medium text-gray-800">
              Nombres <span class="text-red-600">*</span>
            </label>
            <input id="nombres" formControlName="nombres" placeholder="Nombres"
                   class="mt-1 block w-full rounded-lg border-gray-300 focus:border-blue-600 focus:ring-blue-600"/>
          </div>
          <div>
            <label for="apellidos_paterno" class="block text-sm font-medium text-gray-800">
              Apellido paterno <span class="text-red-600">*</span>
            </label>
            <input id="apellidos_paterno" formControlName="apellidos_paterno" placeholder="Apellido paterno"
                   class="mt-1 block w-full rounded-lg border-gray-300 focus:border-blue-600 focus:ring-blue-600"/>
          </div>
          <div>
            <label for="apellidos_materno" class="block text-sm font-medium text-gray-800">
              Apellido materno <span class="text-red-600">*</span>
            </label>
            <input id="apellidos_materno" formControlName="apellidos_materno" placeholder="Apellido materno"
                   class="mt-1 block w-full rounded-lg border-gray-300 focus:border-blue-600 focus:ring-blue-600"/>
          </div>
        </div>

        <!-- Persona Jurídica -->
        <div *ngIf="isJuridica()">
          <label for="razonSocial" class="block text-sm font-medium text-gray-800">
            Razón social <span class="text-red-600">*</span>
          </label>
          <input id="razonSocial" formControlName="razonSocial" placeholder="Razón social"
                 class="mt-1 block w-full rounded-lg border-gray-300 focus:border-blue-600 focus:ring-blue-600"/>
        </div>

        <!-- Contacto -->
        <div class="grid sm:grid-cols-2 gap-4">
          <div>
            <label for="email" class="block text-sm font-medium text-gray-800">
              Correo electrónico <span class="text-red-600">*</span>
            </label>
            <input id="email" type="email" formControlName="email" placeholder="nombre@dominio.com"
                   class="mt-1 block w-full rounded-lg border-gray-300 focus:border-blue-600 focus:ring-blue-600"/>
            <p *ngIf="form.get('email')?.touched && form.get('email')?.invalid"
               class="mt-1 text-sm text-red-600">Ingrese un correo válido.</p>
          </div>
          <div>
            <label for="telefono" class="block text-sm font-medium text-gray-800">Teléfono</label>
            <input id="telefono" formControlName="telefono" placeholder="Opcional"
                   class="mt-1 block w-full rounded-lg border-gray-300 focus:border-blue-600 focus:ring-blue-600"/>
          </div>
        </div>

      </div>
    </section>

    <!-- PASO 2: Ubigeo + Detalle -->
    <section *ngIf="currentStep === 2" class="space-y-6">
      <!-- Ubigeo y dirección -->
      <div class="bg-white rounded-xl shadow-sm ring-1 ring-gray-200">
        <div class="px-5 py-4 border-b border-gray-200 rounded-t-xl bg-gray-50">
          <h2 class="text-base font-semibold text-gray-900">Ubigeo y dirección</h2>
        </div>
        <div class="p-5 space-y-4">
          <div class="grid sm:grid-cols-3 gap-4">
            <div>
              <label for="departamento" class="block text-sm font-medium text-gray-800">
                Departamento <span class="text-red-600">*</span>
              </label>
              <select id="departamento" formControlName="departamento"
                      class="mt-1 block w-full rounded-lg border-gray-300 focus:border-blue-600 focus:ring-blue-600 disabled:bg-gray-100">
                <option [ngValue]="null" disabled>— Seleccione —</option>
                <option *ngFor="let dep of departamentos; trackBy: trackById" [ngValue]="dep.id">
                  {{ dep.nombre }}
                </option>
              </select>
              <p class="mt-1 text-xs text-gray-500" *ngIf="loadingDepartamentos">Cargando departamentos…</p>
            </div>

            <div>
              <label for="provincia" class="block text-sm font-medium text-gray-800">
                Provincia <span class="text-red-600">*</span>
              </label>
              <select id="provincia" formControlName="provincia"
                      class="mt-1 block w-full rounded-lg border-gray-300 focus:border-blue-600 focus:ring-blue-600 disabled:bg-gray-100">
                <option [ngValue]="null" disabled>— Seleccione —</option>
                <option *ngFor="let prov of provincias; trackBy: trackById" [ngValue]="prov.id">
                  {{ prov.nombre }}
                </option>
              </select>
              <p class="mt-1 text-xs text-gray-500" *ngIf="loadingProvincias">Cargando provincias…</p>
            </div>

            <div>
              <label for="distrito" class="block text-sm font-medium text-gray-800">
                Distrito <span class="text-red-600">*</span>
              </label>
              <select id="distrito" formControlName="distrito"
                      class="mt-1 block w-full rounded-lg border-gray-300 focus:border-blue-600 focus:ring-blue-600 disabled:bg-gray-100">
                <option [ngValue]="null" disabled>— Seleccione —</option>
                <option *ngFor="let dist of distritos; trackBy: trackById" [ngValue]="dist.id">
                  {{ dist.nombre }}
                </option>
              </select>
              <p class="mt-1 text-xs text-gray-500" *ngIf="loadingDistritos">Cargando distritos…</p>
            </div>
          </div>

          <div>
            <label for="direccion" class="block text-sm font-medium text-gray-800">Dirección</label>
            <input id="direccion" formControlName="direccion" placeholder="Av., Jr., Calle…"
                   class="mt-1 block w-full rounded-lg border-gray-300 focus:border-blue-600 focus:ring-blue-600"/>
          </div>
        </div>
      </div>

      <!-- Detalle de la solicitud -->
      <div class="bg-white rounded-xl shadow-sm ring-1 ring-gray-200">
        <div class="px-5 py-4 border-b border-gray-200 rounded-t-xl bg-gray-50">
          <h2 class="text-base font-semibold text-gray-900">Detalle de la solicitud</h2>
        </div>
        <div class="p-5 space-y-4">
          <div>
            <label for="descripcion" class="block text-sm font-medium text-gray-800">
              Descripción <span class="text-red-600">*</span>
            </label>
            <textarea id="descripcion" rows="4" formControlName="descripcion" placeholder="Describa su solicitud…"
                      class="mt-1 block w-full rounded-lg border-gray-300 focus:border-blue-600 focus:ring-blue-600"></textarea>
          </div>

          <div class="grid sm:grid-cols-2 gap-4">
            <div>
              <label for="medioEntrega" class="block text-sm font-medium text-gray-800">
                Medio de entrega <span class="text-red-600">*</span>
              </label>
              <select id="medioEntrega" formControlName="medioEntrega"
                      class="mt-1 block w-full rounded-lg border-gray-300 focus:border-blue-600 focus:ring-blue-600">
                <option value="DIGITAL">Digital</option>
                <option value="FISICO">Físico</option>
                <option value="PRESENCIAL">Presencial</option>
              </select>
            </div>
            <div>
              <label for="modalidadNotificacion" class="block text-sm font-medium text-gray-800">
                Modalidad de notificación <span class="text-red-600">*</span>
              </label>
              <select id="modalidadNotificacion" formControlName="modalidadNotificacion"
                      class="mt-1 block w-full rounded-lg border-gray-300 focus:border-blue-600 focus:ring-blue-600">
                <option value="VIRTUAL">Virtual</option>
                <option value="FISICA">Física</option>
              </select>
            </div>
          </div>

          <label class="flex items-start gap-2 mt-2">
            <input type="checkbox" formControlName="aceptaTerminos"
                   class="mt-1 text-blue-600 border-gray-300 rounded focus:ring-blue-600">
            <span class="text-sm text-gray-800">
              Declaro haber leído y acepto los términos y condiciones.
            </span>
          </label>
          <p *ngIf="form.get('aceptaTerminos')?.touched && form.get('aceptaTerminos')?.invalid"
             class="mt-1 text-sm text-red-600">Debes aceptar los términos para continuar.</p>
        </div>
      </div>
    </section>

    <!-- Navegación (botonera) -->
    <div class="flex items-center justify-between">
      <button type="button"
              class="px-4 py-2 rounded-lg border border-gray-300 text-gray-700 hover:bg-gray-50"
              (click)="currentStep === 1 ? (form.reset({ tipoSolicitante: null, tipoDocumento: 'DNI', medioEntrega: 'DIGITAL', modalidadNotificacion: 'VIRTUAL', aceptaTerminos: false }); form.get('provincia')?.disable(); form.get('distrito')?.disable()) : goBack()">
        {{ currentStep === 1 ? 'Limpiar' : '← Anterior' }}
      </button>

      <ng-container *ngIf="currentStep < totalSteps; else enviarBtn">
        <button type="button"
                class="inline-flex items-center justify-center gap-2 px-5 py-2.5 rounded-lg bg-blue-600 text-white hover:bg-blue-700 disabled:opacity-60"
                (click)="goNext()"
                [disabled]="!isStep1Valid()">
          Siguiente →
        </button>
      </ng-container>

      <ng-template #enviarBtn>
        <button type="submit"
                class="inline-flex items-center justify-center gap-2 px-5 py-2.5 rounded-lg bg-blue-600 text-white hover:bg-blue-700 disabled:opacity-60"
                [disabled]="form.invalid || !isStep2Valid()">
          <svg class="w-4 h-4" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true"><path d="M2.5 10a7.5 7.5 0 1115 0 7.5 7.5 0 01-15 0zm8.5-3a1 1 0 10-2 0v2.5H6.5a1 1 0 100 2H9v2.5a1 1 0 102 0V11h2.5a1 1 0 100-2H11V7z"/></svg>
          Enviar solicitud
        </button>
      </ng-template>
    </div>
  </form>

  <!-- Panel lateral -->
  <aside class="lg:col-span-1 space-y-6">
    <section class="bg-blue-50 rounded-xl p-4 ring-1 ring-blue-200">
      <h3 class="text-sm font-semibold text-blue-900">Consejos</h3>
      <ul class="mt-2 text-sm text-blue-900/80 list-disc pl-5 space-y-1">
        <li>Verifique su correo y número antes de enviar.</li>
        <li>Describa su solicitud con el mayor detalle posible.</li>
        <li>Si es persona jurídica, el RUC debe estar activo y habido.</li>
      </ul>
    </section>

    <section class="bg-white rounded-xl p-4 ring-1 ring-gray-200">
      <h3 class="text-sm font-semibold text-gray-900">Resumen</h3>
      <p class="mt-2 text-sm text-gray-600">Revise que los datos coincidan antes de enviar.</p>
      <div class="mt-3 text-sm text-gray-700 space-y-1">
        <div><span class="text-gray-500">Tipo:</span> {{ tipoSolicitante || '—' }}</div>
        <div><span class="text-gray-500">Departamento:</span> {{ nombreDepartamento }}</div>
        <div><span class="text-gray-500">Provincia:</span> {{ nombreProvincia }}</div>
        <div><span class="text-gray-500">Distrito:</span> {{ nombreDistrito }}</div>
      </div>
    </section>

    <p *ngIf="mensaje" class="text-green-700 bg-green-50 border border-green-200 rounded-lg p-3">
      {{ mensaje }}
    </p>
  </aside>
</div>
